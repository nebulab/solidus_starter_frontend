<% if order.has_checkout_step?("address") %>
  <h6>
    <%= t('spree.billing_address') %>
    <%= link_to "(#{t('spree.actions.edit')})", checkout_state_path(:address) unless order.completed? %>
  </h6>
  <%= render partial: 'spree/shared/address', locals: { address: order.bill_address } %>

  <% if order.has_checkout_step?("delivery") %>
    <h6>
      <%= t('spree.shipping_address') %>
      <%= link_to "(#{t('spree.actions.edit')})", checkout_state_path(:address) unless order.completed? %>
    </h6>
    <%= render partial: 'spree/shared/address', locals: { address: order.ship_address } %>

    <h6>
      <%= t('spree.shipments') %>
      <%= link_to "(#{t('spree.actions.edit')})", checkout_state_path(:delivery) unless order.completed? %>
    </h6>
    <ul>
      <% order.shipments.each do |shipment| %>
        <li>
          <i class='fa fa-truck'></i>
          <%= t(
            'spree.shipment_details',
            stock_location: shipment.stock_location.name,
            shipping_method: shipment.selected_shipping_rate.name) %>
        </li>
      <% end %>
    </ul>
    <%= render(partial: 'spree/shared/shipment_tracking', locals: {order: order}) if order.shipped? %>
  <% end %>
<% end %>

<div class="payment-info">
  <% if order.has_checkout_step?("payment") %>
    <h6>
      <%= t('spree.payment_information') %>
      <%= link_to "(#{t('spree.actions.edit')})", checkout_state_path(:payment) unless order.completed? %>
    </h6>

    <% order.payments.valid.each do |payment| %>
      <%= render payment %>
    <% end %>
  <% end %>
</div>

<table id="line-items">
  <thead>
    <tr>
      <th><%= t('spree.item') %></th>
      <th><%= t('spree.price') %></th>
      <th><%= t('spree.qty') %></th>
      <th><%= t('spree.total') %></th>
    </tr>
  </thead>

  <tbody>
    <% order.line_items.each do |item| %>
      <tr>
        <td>
          <%= link_to(render('spree/shared/image',
            image: (item.variant.gallery.images.first || item.variant.product.gallery.images.first),
            size: :small), item.variant.product) %>
          <h4><%= item.variant.product.name %></h4>
          <%= truncated_product_description(item.variant.product) %>
          <%= "(" + item.variant.options_text + ")" unless item.variant.option_values.empty? %>
        </td>
        <td class="price"><%= item.single_money.to_html %></td>
        <td><%= item.quantity %></td>
        <td><%= item.display_amount.to_html %></td>
      </tr>
    <% end %>
  </tbody>
  <tfoot id="order-total">
    <tr>
      <td><%= t('spree.order_total') %>:</td>
      <td>
        <span id="order_total"><%= order.display_order_total_after_store_credit.to_html %></span>
      </td>
    </tr>
  </tfoot>

  <tfoot id="subtotal">
    <tr>
      <td><%= t('spree.subtotal') %>:</td>
      <td><%= order.display_item_total.to_html %></td>
    </tr>
  </tfoot>

  <% if order.line_item_adjustments.exists? %>
    <% if order.line_item_adjustments.promotion.eligible.exists? %>
      <tfoot id="price-adjustments">
        <% order.line_item_adjustments.promotion.eligible.group_by(&:label).each do |label, adjustments| %>
          <tr>
            <td>
              <%= t('spree.promotion') %>: <strong><%= label %></strong>
            </td>
            <td><%= Spree::Money.new(adjustments.sum(&:amount), currency: order.currency) %></td>
          </tr>
        <% end %>
      </tfoot>
    <% end %>
  <% end %>

  <tfoot id='shipment-total'>
    <% order.shipments.group_by { |s| s.selected_shipping_rate.name }.each do |name, shipments| %>
      <tr>
        <td>
          <%= t('spree.shipping') %>: <strong><%= name %></strong>
        </td>
        <td><%= Spree::Money.new(shipments.sum(&:total_before_tax), currency: order.currency).to_html %></td>
      </tr>
    <% end %>
  </tfoot>

  <% if order.all_adjustments.tax.exists? %>
    <tfoot id="tax-adjustments">
      <% order.all_adjustments.tax.group_by(&:label).each do |label, adjustments| %>
        <tr>
          <td>
            <%= t('spree.tax') %>: <strong><%= label %></strong>
          </td>
          <td><%= Spree::Money.new(adjustments.sum(&:amount), currency: order.currency) %></td>
        </tr>
      <% end %>
    </tfoot>
  <% end %>

  <% if order.total_applicable_store_credit > 0.0 %>
    <tfoot id="store-credit">
      <tr>
        <td><%= t('spree.store_credit.store_credit') %>:</td>
        <td><%= order.display_total_applicable_store_credit.to_html %></td>
      </tr>
    </tfoot>
  <% end %>

  <tfoot id="order-charges">
    <% order.adjustments.eligible.each do |adjustment| %>
    <% next if (adjustment.source_type == 'Spree::TaxRate') and (adjustment.amount == 0) %>
      <tr>
        <td><%= adjustment.label %></td>
        <td><%= adjustment.display_amount.to_html %></td>
      </tr>
    <% end %>
  </tfoot>
</table>
